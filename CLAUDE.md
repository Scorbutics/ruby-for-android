# CRuby Cross-Platform - Context Guide for Claude Code

## Project Overview

**Purpose**: Cross-compile CRuby 3.1.1 (MRI - Matz's Ruby Interpreter) as a Position Independent Executable (PIE) for any Unix-based platform including Android 8+ (API 26) and iOS.

**Origin**: Forked from https://github.com/sfrieske/ruby-for-android5 (2015, now outdated).

**Target Platforms**: 
- **Android** (ARM64-v8a, x86_64) - API Level 26+ (Android 8.0+) - Fully supported
- **Linux** (x86_64, ARM64) - Fully supported
- **macOS** (x86_64, ARM64) - Planned
- **iOS** (ARM64, Simulator) - Planned

**Output**: A full-featured CRuby environment (~27MB) with complete stdlib and native extensions.

## Architecture

### Build System

The project uses a **CMake-based** build system with Docker containerization for cross-platform builds.

#### Key Build Flow

The project follows the **standard Linux build convention**: `./configure`, `make`, `make install`

```
./configure [options] → make → make install
     ↓                    ↓           ↓
Generate Makefile    CMake build   Export artifacts
```

1. **Configuration Phase** (`./configure`)
   - Parses command-line options (--without-docker, --with-toolchain-params, etc.)
   - Validates toolchain parameters and dependencies
   - Generates a Makefile configured for Docker or local build
   - Sets up build environment

2. **Build Phase** (`make`)
   - Runs CMake configuration (calls internal configure script)
   - Downloads dependencies
   - Extracts source archives
   - Applies platform-specific patches
   - Configures and builds each dependency
   - Builds Ruby and creates `ruby_full.zip` archive
   - Works in Docker mode (default) or local mode (--without-docker)

3. **Install Phase** (`make install`)
   - Exports build artifacts from Docker container (Docker mode)
   - Or copies from build directory (local mode)
   - Places artifacts in `./target/` directory
   - Makes `ruby_full.zip` available on the host

4. **Docker Workflow** (when using Docker mode)
   - Uses the docker-compose.yml file to build the docker image
   - Syncs source via rsync to named volume
   - Persistent dev container for iterative builds
   - Isolates build environment from host

### Directory Structure

```
ruby-for-android/
├── CMakeLists.txt                      # Main entry point (20 lines)
├── configure                           # Configuration script (generates Makefile)
├── Makefile                            # Generated by ./configure (gitignored)
├── *.params                            # Toolchain parameter files
│   ├── arm64-v8a-android-toolchain.params
│   ├── x86_64-android-toolchain.params
│   └── x86_64-linux-toolchain.params
├── cmake/
│   ├── core/                           # Generic build system (reusable)
│   │   ├── Main.cmake                  # declare_application() function
│   │   ├── BuildHelpers.cmake          # add_external_dependency(), create_archive_target()
│   │   ├── PlatformDetection.cmake     # Platform/arch detection
│   │   ├── Validation.cmake            # Configuration validation
│   │   └── platforms/                  # Platform-specific configurations
│   │       ├── Android.cmake           # Android toolchain setup
│   │       ├── Linux.cmake             # Linux configuration
│   │       ├── macOS.cmake             # macOS configuration
│   │       └── iOS.cmake               # iOS configuration
│   └── ruby-app/                       # Ruby application layer
│       ├── dependencies/               # Per-dependency configs
│       │   ├── ncurses.cmake           # ncurses 6.4
│       │   ├── readline.cmake          # readline 8.1
│       │   ├── gdbm.cmake              # gdbm 1.18.1
│       │   ├── openssl.cmake           # openssl 1.1.1m
│       │   └── ruby.cmake              # ruby 3.1.1
│       └── patches/                    # Organized patches
│           ├── ncurses/
│           │   ├── android/
│           │   │   ├── series          # Patch order
│           │   │   └── *.patch
│           │   └── linux/
│           ├── readline/
│           │   └── android/
│           ├── gdbm/
│           │   ├── android/
│           │   └── linux/
│           ├── openssl/
│           │   └── android/
│           │       └── 1.1.1k/         # Version-specific patches
│           └── ruby/
│               └── android/
│                   └── 3.0.0/          # Version-specific patches
├── utilities/                          # Runtime helper scripts
│   ├── constants.sh                    # Common constants
│   ├── setup_ruby.sh                   # Environment setup script
│   └── run_ruby.sh                     # Ruby execution wrapper
├── docker/                             # Docker configuration
├── docker-compose.yml                  # Docker services definition
├── build/                              # Generated build directory (gitignored)
│   ├── download/                       # Downloaded sources
│   ├── {dependency}/                   # Per-dependency build dirs
│   └── target/                         # Installed binaries (staging)
└── target/                             # Final artifacts (gitignored)
    └── ruby_full-{platform}-{arch}.zip # Final distribution
```

## Dependencies

All dependencies are downloaded, patched, and built automatically by the CMake build system.

### Current Versions

| Dependency | Version | Purpose |
|------------|---------|---------|
| Ruby | 3.1.1 | Main CRuby interpreter |
| OpenSSL | 1.1.1m | SSL/TLS support |
| GDBM | 1.18.1 | DBM database support |
| ncurses | 6.4 | Terminal control |
| readline | 8.1 | Line editing/history |

### Build Process for Each Dependency

The build system implements a **generic build pattern**:

1. **Download**: Fetch source tarball from upstream
2. **Extract**: Unpack the download
3. **Patch**: Apply platform compatibility patches
4. **Configure**: Run autoconf/configure with cross-compile flags
5. **Build**: Run make (or custom build command)
6. **Install**: Install to `CMAKE_BINARY_DIR/target/` as DESTDIR

## Platform-Specific Modifications

### Supported Platforms

The build system includes platform-specific modules in `cmake/core/platforms/`:

1. **Android.cmake** - Android NDK cross-compilation (API 26+)
2. **Linux.cmake** - Native Linux builds
3. **macOS.cmake** - macOS builds (x86_64, ARM64)
4. **iOS.cmake** - iOS cross-compilation (device and simulator)

### Patch Organization

Patches are organized by library and platform in `cmake/ruby-app/patches/`:

```
patches/
└── {library}/
    ├── android/
    │   ├── series              # Patch application order
    │   └── *.patch             # Platform-specific patches
    └── linux/
        ├── series
        └── *.patch
```

The `series` file lists patches in application order (one per line).

### Patch Categories

1. **Android SONAME Versioning Removal**
   - Libraries: ncurses, readline, gdbm, openssl, ruby
   - Reason: Android's linker expects unversioned libraries (e.g., `libssl.so` not `libssl.so.1.1`)
   - Files: `patches/{lib}/android/soname-without-version*.patch`

2. **Ruby Type Redefinition Fix** (Ruby 3.0.0 only)
   - File: `patches/ruby/android/3.0.0/3.0.0-cross-compile.patch`
   - Issue: Clang has built-in types (`size_t`, `intptr_t`, etc.)
   - Fix: Remove redundant type definitions in configure script
   - Note: Not needed for Ruby 3.1.1+ (current version)

3. **OpenSSL Android NDK r22+ Support** (OpenSSL 1.1.1k only)
   - File: `patches/openssl/android/1.1.1k/1.1.1k-ndk-r22.patch`
   - Issue: Type compatibility with newer NDK
   - Note: Not needed for OpenSSL 1.1.1m+ (current version)

4. **GDBM GCC 10 Link Failure Fix** (Linux only)
   - File: `patches/gdbm/linux/gdbm-fix-link-failure-against-gcc-10.patch`
   - Issue: Link failures with GCC 10+
   - Platform: Linux only

## Build Artifacts

### Build Artifacts Structure

After running `make install`, artifacts are exported to `./target/`:

```
target/
└── ruby_full-{platform}-{arch}.zip    # Main distribution archive
```

The archive contains:

```
ruby_full-{platform}-{arch}/
├── usr/
│   ├── include/                       # Headers from dependencies
│   ├── lib/                           # Shared libraries from deps
│   │   ├── libcrypto.so*              # OpenSSL crypto
│   │   ├── libssl.so*                 # OpenSSL SSL
│   │   ├── libgdbm.so*                # GDBM database
│   │   ├── libncurses.so*             # ncurses terminal
│   │   └── libreadline.so*            # readline
│   └── local/
│       ├── bin/                       # Ruby executables
│       │   ├── ruby                   # Ruby interpreter
│       │   ├── irb                    # Interactive Ruby
│       │   ├── gem                    # RubyGems
│       │   ├── rake                   # Build tool
│       │   └── bundle                 # Bundler
│       └── lib/
│           ├── libruby.so*            # Ruby runtime library
│           └── ruby/
│               ├── 3.1.0/             # Ruby stdlib
│               │   ├── {arch}/        # Native extensions
│               │   └── *.rb           # Ruby standard library
│               └── gems/              # Gem specifications
└── setup_ruby.sh                      # Environment setup script
```

### Ruby Full ZIP Contents

The `ruby_full-{platform}-{arch}.zip` archive includes:
- All shared libraries (libruby.so, libssl.so, libcrypto.so, libgdbm.so, libncurses.so, libreadline.so)
- Complete Ruby 3.1.0 standard library
- Native extension gems (compiled against platform-specific libs)
- Ruby executables (ruby, irb, gem, rake, bundle)
- Environment setup script (`setup_ruby.sh`)

## Runtime Deployment

### On Target Device

1. Extract `ruby_full-{platform}-{arch}.zip` to device (e.g., `/data/local/tmp/ruby/` on Android)
2. Source the environment setup:
   ```sh
   # Arguments: <root_path> <ruby_version> <architecture>
   . /data/local/tmp/ruby/setup_ruby.sh /data/local/tmp/ruby 3.1.0 aarch64
   ```
3. Run Ruby:
   ```sh
   ruby -v
   irb
   ```

### Environment Variables Set by setup_ruby.sh

- `LD_LIBRARY_PATH`: Points to Ruby's shared libraries
- `PATH`: Includes Ruby's bin directory
- `GEM_PATH`: Gem installation directory
- `GEM_HOME`: Gem installation directory
- `GEM_SPEC_CACHE`: Gem specifications directory
- `RUBYLIB`: Ruby library search paths

## Development Workflows

### Quick Start (Standard Linux Workflow)

```sh
# 1. Configure the build (uses Docker by default)
./configure

# 2. Build the project
make

# 3. Export/install artifacts to ./target/
make install

# Output: ./target/ruby_full-{platform}-{arch}.zip
```

### Configuration Options

```sh
# Build with Docker (default - requires Docker image)
./configure

# Build without Docker (local toolchain)
./configure --without-docker

# Use a different toolchain
./configure --with-toolchain-params=x86_64-android-toolchain.params

# Combine options
./configure --without-docker --with-toolchain-params=x86_64-linux-toolchain.params

# See all options
./configure --help
```
### Requirements for manual Build (Without Docker)

For local builds without Docker:

1. Install required tools:
   - CMake 3.10+
   - make
   - autoconf
   - Ruby 3.0.0+
   - Android NDK r23b+ (if targeting Android)

2. Set environment variables (for Android builds):
   ```sh
   export ANDROID_NDK=/path/to/android/ndk
   ```

3. Configure, build and export artifacts:
   ```sh
   ./configure --without-docker --with-toolchain-params=your-toolchain.params
   make
   make install
   ```

### Cleaning

```sh
# Clean build artifacts (keeps downloads)
make clean

# Clean library build directories
make clean-libs

# Clean downloaded source archives
make clean-downloads

# Clean target directory
make clean-artifacts

# Clean everything (libs + downloads + artifacts)
make clean-all
```

## Key Implementation Details

### CMake Targets

Each dependency gets these targets (automatically generated by `add_external_dependency()`):
- `{lib}_download`: Fetch source tarball
- `{lib}_extract`: Unpack source
- `{lib}_patch`: Apply platform-specific patches from series file
- `{lib}_configure`: Run configure script with cross-compile flags
- `{lib}_build`: Compile the library
- `{lib}_install`: Install to `BUILD_STAGING_DIR`
- `{lib}_clean`: Remove build directory
- `{lib}_external`: ExternalProject target (internal)
- `{lib}`: Alias for the complete build chain

Ruby-specific targets:
- `ruby_archive`: Create `ruby_full-{platform}-{arch}.zip`
- `ruby`: Build Ruby + create archive (complete)

Global targets:
- `all`: Build all dependencies and create archives (default)
- `clean`: Clean build artifacts (keeps downloads)
- `clean-libs`: Clean all library build directories
- `clean-artifacts`: Remove `BUILD_STAGING_DIR`
- `clean-downloads`: Remove `BUILD_DOWNLOAD_DIR`
- `clean-all`: All of the above

### Dependency Chain

```
ncurses → readline → ruby
         openssl  ↗
         gdbm    ↗
```

Ruby depends on all other libraries. The CMake build system handles ordering.

### Size Concerns

**Note**: Full Ruby is ~27MB. For embedded devices needing smaller footprint, consider mRuby instead.

## Important Configuration Files

### arm64-v8a-android-toolchain.params

Single-line CMake arguments:
```
-DANDROID_STL=c++_shared
-DANDROID_PLATFORM=android-26
-DANDROID_ABI=arm64-v8a
-DHOST=aarch64-linux-android
-DHOST_SHORT=android-arm64
```

### docker-compose.yml

Two services:
- `init`: rsync source to named volume
- `ruby-android-ndk`: Build container with an interactive shell as entrypoint

## Cross-Compilation Glossary

- **Host**: Machine running the build (e.g., x86_64 Linux)
- **Target**: Machine running the binary (e.g., aarch64 Android)
- **Toolchain**: Compiler and tools for cross-compilation
- **DESTDIR**: Staging directory for install (not final runtime path)
- **PIE**: Position Independent Executable (required for Android 5+)
- **SONAME**: Shared object name embedded in ELF binary

## Testing Strategy

1. Build for target architecture
2. Deploy `ruby_full-<platform>.zip` to your target device
3. Extract and source `setup_ruby.sh`
4. Run test suite:
   ```sh
   ruby -e "puts RUBY_VERSION"
   ruby -e "require 'openssl'; puts OpenSSL::OPENSSL_VERSION"
   ruby -e "require 'gdbm'"
   ruby -e "require 'readline'"
   irb  # Interactive Ruby
   ```

## Future Considerations

- **Platform Support Status**:
  - Android (ARM64-v8a, x86_64): Fully supported and tested
  - Linux (x86_64, ARM64): In development
  - macOS (x86_64, ARM64): Planned (platform module exists)
  - iOS (ARM64, Simulator): Planned (platform module exists)
- **Android API Level**: Version < 8 (API < 26) not supported (no plans to support)
- **Windows Hosts**: Should use Docker workflow (or WSL for local builds)
- **Adding New Dependencies**: 
  1. Create `cmake/ruby-app/dependencies/{dep}.cmake`
  2. Use `add_external_dependency()` function
  3. Add patches in `cmake/ruby-app/patches/{dep}/{platform}/`
  4. Create `series` file listing patches in order
  5. Add dependency name to `APP_DEPENDENCIES` in `CMakeLists.txt`
- **Custom Architectures**: Create new `{arch}-{platform}-toolchain.params` file and use with `./configure --with-toolchain-params=...`
- **Reusing Core Build System**: The `cmake/core/` directory is generic and can be reused for other C/C++ cross-platform projects

## References

- CRuby: https://www.ruby-lang.org/
- Android NDK: https://developer.android.com/ndk
- CMake Android: https://cmake.org/cmake/help/latest/manual/cmake-toolchains.7.html#cross-compiling-for-android
- Original Project: https://github.com/sfrieske/ruby-for-android5
